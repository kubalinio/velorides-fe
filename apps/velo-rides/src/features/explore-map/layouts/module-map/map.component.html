<section class="map-container relative">
  <mgl-map
    #mapInstance
    [style]="$mapTiles()"
    [zoom]="[$mapInitService.initialZoom]"
    [center]="$mapInitService.initialCenter"
    [cursorStyle]="$mapInteraction.cursorStyle"
    [fitBoundsOptions]="{
      padding: 10,
    }"
    [maxZoom]="18"
    (mapLoad)="$mapInitService.onMapReady($event)"
    (moveEnd)="$mapInteraction.onMapMoveEnd()"
  >
    <mgl-geojson-source id="routes">
      @for (
        route of $routesWithUncompletedData()?.features ?? [];
        track route.properties['id']
      ) {
        <mgl-feature
          [geometry]="route.geometry"
          [properties]="route.properties"
        ></mgl-feature>
      }
    </mgl-geojson-source>

    <viewing-map-viewpoints
      (centerMapToCluster)="
        $mapNavigationService.centerMapToCluster($event)
      "
    ></viewing-map-viewpoints>

    <mgl-layer
      id="route"
      type="line"
      source="routes"
      [layout]="{
        'line-join': 'round',
        'line-cap': 'round',
      }"
      [paint]="{
        'line-color': [
          'match',
          ['get', 'network'],
          'icn',
          '#8b5cf6',
          'ncn',
          '#b91c1c',
          'rcn',
          '#f97316',
          'lcn',
          '#000000',
          '#000000',
        ],
        'line-width': [
          'case',
          [
            '==',
            ['get', 'id'],
            $mapNavigationService.$selectedRoute()?.['id'] ?? '',
          ],
          4,
          2,
        ],
        'line-opacity': [
          'case',
          [
            '==',
            ['get', 'id'],
            $mapNavigationService.$selectedRoute()?.['id'] ?? '',
          ],
          0.9,
          0.5,
        ],
        'line-gap-width': 0,
        'line-blur': 0,
        'line-translate': [0, 0],
      }"
    >
    </mgl-layer>
    <mgl-layer
      id="route-hover"
      type="line"
      source="routes"
      [layout]="{
        'line-join': 'round',
        'line-cap': 'round',
      }"
      [paint]="{
        'line-color': '#888',
        'line-width': 16,
        'line-opacity': 0,
      }"
      (layerMouseEnter)="$mapInteraction.onMouseEnter($event)"
      (layerMouseMove)="$mapInteraction.onMouseMove($event)"
      (layerMouseLeave)="$mapInteraction.onMouseLeave()"
      (layerClick)="$mapInteraction.onRouteClick($event)"
    >
    </mgl-layer>

    <map-hover-popup
      [hoverRoute]="$mapInteraction.hoverRoute"
    ></map-hover-popup>

    <map-click-popup
      [selectedRoute]="$mapNavigationService.$selectedRoute()"
      [clickPopupFeature]="$mapInteraction.clickPopupFeature"
      (closePopup)="$mapNavigationService.clearSelectedRoute()"
      (zoomToRoute)="$mapNavigationService.zoomToRoute($event)"
    ></map-click-popup>
  </mgl-map>

  <sidebar-button></sidebar-button>

  <filters-route></filters-route>

  <filters-waypoints></filters-waypoints>
</section>
